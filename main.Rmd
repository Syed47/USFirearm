---
title: "USFirearm"
author: "Syed Baryalay"
date: "`r Sys.Date()`"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE, fig.width=6, fig.height=3}
knitr::opts_chunk$set(echo = TRUE)
```


###

Generate some insightful visualizations to display this data. 

Does the rate of change in total firearms background checks over time vary across states?



```{r}
suppressMessages(library(tidyverse))
suppressMessages(library(dplyr))
suppressMessages(library(tidyr))
suppressMessages(library(fpp3))
suppressMessages(library(readr))
suppressMessages(library(forecast))
suppressMessages(library(ggplot2))

url <- "https://raw.githubusercontent.com/BuzzFeedNews/nics-firearm-background-checks/master/data/nics-firearm-background-checks.csv"

firearm <- read.csv(url, header = TRUE)
glimpse(firearm)
```



**Cleaning and filtering original data for analysis**


```{r}
dat <- firearm %>% 
  mutate(date = ymd(paste(month, "01"))) %>%
  select(date, state, totals) %>% 
  filter(complete.cases(.)) 

glimpse(dat)
```


**Plot of total background checks in each state as well as overall mean.**

```{r fig.width=6, fig.height=6}
ggplot(dat) + 
    geom_line(mapping=aes(x=date, y=totals, color=state)) +
    geom_line(dat %>% group_by(date) %>% summarise(totals=mean(totals)), 
              mapping=aes(x=date, y=totals)) +
    theme(legend.position="bottom",
          legend.title = element_text(size=10), 
          legend.text=element_text(size=6))
```


**Plot of total background checks in each state as well as overall mean on the _log_ scale**

```{r fig.width=6, fig.height=6}
ggplot(dat) + 
    geom_line(mapping=aes(x=date, y=log(totals), color=state)) +
    geom_line(dat %>% group_by(date) %>% summarise(totals=mean(totals)), 
              mapping=aes(x=date, y=log(totals))) +
    theme(legend.position="bottom",
          legend.title = element_text( size=10), 
          legend.text=element_text(size=6))
```



**Time series decomposition of total background firearm checks**

_we are only interested in trend but we need to get rid of seasonal effect_

```{r}
firearm_ts <- ts(dat$totals, 
             start = min(year(dat$date)), 
             end = max(year(dat$date)), 
             frequency = 12)
# Decomposing the model and extracting trend component
fit_dcmp <- decompose(firearm_ts)
trend <- fit_dcmp$trend # important
# firearm_seasonal <- fit_dcmp$seasonal
# firearm_remainder <- fit_dcmp$random

autoplot(fit_dcmp) + 
  xlab("Year") + 
  ylab("Total Background Checks") + 
  ggtitle("USFirearm Decomposition")


autoplot(trend) + xlab("Year") + ylab("Total Background Checks") + 
  ggtitle("Overall Trend of firearm background checks in US")

```

we can see that there is cyclone repeating every 4 years or so.